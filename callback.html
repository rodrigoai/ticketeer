<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Auth0 Callback - Ticketeer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  </head>
  <body>
    <div class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-6 text-center">
          <div class="card">
            <div class="card-body" id="callback-content">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <h4 class="mt-3">üé´ Processing authentication...</h4>
              <p class="text-muted">Please wait while we complete your login to Ticketeer.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Auth0 SPA SDK -->
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"></script>
    <script>
      // Handle Auth0 callback
      async function handleCallback() {
        try {
          console.log('Starting Auth0 callback handling...');
          
          // Configuration - will be replaced with actual values when Auth0 is set up
          const auth0Config = {
            domain: 'your-domain.auth0.com', // Replace with your Auth0 domain
            clientId: 'your-client-id',      // Replace with your Auth0 client ID
            authorizationParams: {
              redirect_uri: window.location.origin + '/callback'
            }
          };

          // Create Auth0 client
          const auth0Client = await auth0.createAuth0Client(auth0Config);

          // Check if we have callback parameters
          const urlParams = new URLSearchParams(window.location.search);
          const hasCode = urlParams.has('code');
          const hasError = urlParams.has('error');

          if (hasCode || hasError) {
            console.log('Processing callback with parameters:', { hasCode, hasError });
            
            if (hasError) {
              const error = urlParams.get('error');
              const errorDescription = urlParams.get('error_description');
              throw new Error(errorDescription || error || 'Authentication failed');
            }

            // Handle the successful callback
            const redirectResult = await auth0Client.handleRedirectCallback();
            console.log('Authentication successful:', redirectResult);
            
            // Show success message briefly
            document.getElementById('callback-content').innerHTML = `
              <div class="text-success">
                <div class="display-1">‚úÖ</div>
                <h4 class="mt-3">Authentication Successful!</h4>
                <p>Redirecting to your dashboard...</p>
              </div>
            `;
            
            // Redirect to the target URL after a brief delay
            setTimeout(() => {
              const targetUrl = redirectResult.appState?.targetUrl || '/';
              window.location.replace(targetUrl);
            }, 1500);
            
          } else {
            // No callback parameters found
            console.log('No callback parameters found');
            document.getElementById('callback-content').innerHTML = `
              <div class="text-warning">
                <div class="display-1">‚ö†Ô∏è</div>
                <h4 class="mt-3">No Authentication Data</h4>
                <p>Redirecting to home page...</p>
              </div>
            `;
            
            setTimeout(() => {
              window.location.replace('/');
            }, 2000);
          }
          
        } catch (error) {
          console.error('Authentication error:', error);
          
          // Display error message
          document.getElementById('callback-content').innerHTML = `
            <div class="text-danger">
              <div class="display-1">‚ùå</div>
              <h4 class="mt-3">Authentication Error</h4>
              <p class="mb-3">${error.message || 'An error occurred during authentication.'}</p>
              <a href="/" class="btn btn-primary">üè† Return to Home</a>
            </div>
          `;
        }
      }

      // Start handling the callback when the page loads
      window.addEventListener('load', handleCallback);
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  </body>
</html>
